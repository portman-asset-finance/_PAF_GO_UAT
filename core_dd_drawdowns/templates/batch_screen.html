{% extends 'dashboard_base.html' %}

{% load staticfiles %}
{% load humanize %}

{% block page-css %}
    <link rel="stylesheet" href="{% static 'assets/vendor/chartist-js/dist/chartist.min.css' %}">
    <style type="text/css">
        .forecast_bounce_info {
            color: #A7A7A7;
            display: none;
        }
        .cursor-pointer {
            cursor: pointer;
        }
        #myBar {
            width: 10%;
            height: 30px;
            background-color: #2acfd2;
            text-align: center; /* To center it horizontally (if you want) */
            line-height: 30px; /* To center it vertically */
            color: white;
        }
    </style>
{% endblock %}

{% block content %}

    {% if seconds_remaining %}
        <div class="alert alert-danger">
            Please try again in {{ seconds_remaining }} seconds...
        </div>
    {% else %}

    <div class="page-header">
        <h2 class="header-title" style="color: #8dabc4">
            {% if history %}
                VIEW BATCH
            {% else %}
                CREATE BATCH
            {% endif %}
        </h2>
        <h2 class="header-title">
            {% if batch_ref %}
                {{ batch_ref }}
            {% endif %}
            for {{ uk_due_date }}
        </h2>
        <h2 class="header-title">
            {% if status == 'OPEN' %}
                <span class="badge badge-primary">OPEN</span>
            {% elif status == 'RECEIVED' %}
                <span class="badge badge-success">RECEIVED</span>
            {% elif status == 'PROCESSING' %}
                <span class="badge badge-info">PROCESSING</span>
            {% elif status == 'ARCHIVED' %}
                <span class="badge badge-secondary">ARCHIVED</span>
            {% else %}
                <span class="badge badge-danger">{{ status }}</span>
            {% endif %}
        </h2>
        <div class="header-sub-title">
            <nav class="breadcrumb breadcrumb-dash">
                <a class="breadcrumb-item text-success dd-batch-history-list" href="{% url 'core_dd_drawdowns:view_batches' %}"><i class="ti-list p-r-5"></i>DD Batch History</a>
            </nav>
        </div>

        {% if total_count %}<p><i class="fa fa-clock-o"></i> created on {{ created_on }} &nbsp; <i class="fa fa-user"></i> by user {% if created_by %}{{ created_by }}{% else %}lazybatch{% endif %}</p>{% endif %}

    </div>

    <div class="alert alert-danger bold" id="batch_error" style="display: none;">

    </div>

    {% if success %}
        <div class="col-sm-12">
            <div class="alert alert-success">
                <b>Success:</b> Batch has been ACCEPTED
            </div>
        </div>
    {% endif %}

    {% if remove_success %}
        <div class="col-sm-12" id="remove-success">
            <div class="alert alert-success">
                <b>Success:</b> Drawdown has been removed
            </div>
        </div>
    {% endif %}

    {% if error %}

        <div class="col-sm-12">
            <div class="alert alert-danger">
                <b>Error:</b> {{ error }}
            </div>
        </div>

    {% else %}

        {% if total_count == 0 or not batch_ref %}

            <div class="card">
                <div class="card-header">
                    0 drawdowns found.
                </div>
            </div>

        {% elif batch_ref %}

            <div class="card" id="batch_info" style="display: none;">
                <div class="card-header p-b-20">
                    <form method="get" class="form-inline">
                        <span class="m-b-20 m-r-15"><h4 class="text-thin">Filter by: </h4></span>
                        <input type="text" class="form-control m-b-20 m-r-15" placeholder="Agreement ID..." name="agreement_id__contains" value="{{ filter.agreement_id__contains }}" autocomplete="off">
                        <span class="m-b-20 m-r-15"><h4 class="text-thin">and</h4></span>
                            <input type="text" class="form-control m-b-20 m-r-15" placeholder="Amount..." name="amount" value="{{ filter.amount }}" autocomplete="off">
                        <span class="m-b-20 m-r-15"><h4 class="text-thin">and</h4></span>
                            <select class="form-control m-b-20 m-r-15" name="ddi_status">
                                <option value="">DDI status</option>
                                <option value="Active DD" {% if filter.ddi_status == 'Active DD' %}selected{% endif %}>Active DD</option>
                                <option value="Inactive DD" {% if filter.ddi_status == 'Inactive DD' %}selected{% endif %}>Inactive DD</option>
                                <option value="No Setup" {% if filter.ddi_status == 'No Setup' %}selected{% endif %}>No Setup</option>
                            </select>
                        <span class="m-b-20 m-r-15"><h4 class="text-thin">and</h4></span>
                        <select class="form-control m-b-20 m-r-15" name="status">
                            <option value="">Status</option>
                            <option value="OPEN" {% if filter.status == 'OPEN' %}selected{% endif %}>OPEN</option>
                            <option value="REMOVED" {% if filter.status == 'REMOVED' %}selected{% endif %}>REMOVED</option>
                        </select>
                        <button type="submit" class="btn btn-icon btn-success m-b-20" onclick="window.performUnload=false;" >
                            <i class="mdi mdi-magnify"></i>
                        </button>
                        {% if filter %}
                            {% if history %}
                                <a class="btn btn-icon btn-warning m-b-20" href="{% url 'core_dd_drawdowns:view_batch' batch_id %}">
                                    <i class="mdi mdi-refresh"></i>
                                </a>
                            {% else %}
                                <a onclick="window.performUnload=false;" class="btn btn-icon btn-warning m-b-20" href="{% url 'core_dd_drawdowns:view_batch' batch_id %}">
                                    <i class="mdi mdi-refresh"></i>
                                </a>
                            {% endif %}
                        {% endif %}
                    </form>
                    <div class="row border top p-t-10">
                        <div class="col-md-3">
                            <div class="card m-b-0">
                                <div class="card-body">
                                    <div class="media">
                                        <div class="align-self-center">
                                            <i class="fa fa-info font-size-30"></i>
                                        </div>
                                        <div class="m-l-20">
                                            <p class="m-b-0">Funder</p>
                                            <h1 class="m-b-0">
                                                {% if funder_code == 1 %}
                                                    <span class="badge badge-default x2">Nationwide</span>
                                                {% elif funder_code == 2 %}
                                                    <span class="badge badge-success x2">BlueRock</span>
                                                {% else %}
                                                    <span class="badge badge-danger">Issue</span>
                                                {% endif %}
                                            </h1>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card m-b-0">
                                <div class="card-body">
                                    <div class="media">
                                        <div class="align-self-center">
                                            <i class="fa fa-bank font-size-30"></i>
                                        </div>
                                        <div class="m-l-20">
                                            <p class="m-b-0">Total Amount</p>
                                            <h2 class="m-b-0">&pound;<span id="id-total-amount">{{ amount|intcomma }}</span></h2>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card m-b-0">
                                <div class="card-body">
                                    <div class="media">
                                        <div class="align-self-center">
                                            <i class="fa fa-line-chart font-size-30"></i>
                                        </div>
                                        <div class="m-l-20">
                                            <p class="m-b-0">Total Count</p>
                                            <h2 class="m-b-0">
                                                <span id="id-total-count">{{ count }}</span>
                                            </h2>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                         <div class="col-md-3">
                            <div class="card m-b-0">
                                <div class="card-body">
                                    <div class="media">
                                        <div class="align-self-center">
                                            <i class="fa fa-calendar font-size-30"></i>
                                        </div>
                                        <div class="m-l-20">
                                            <p class="m-b-0">DD Actual Due Date</p>
                                            <h2 class="m-b-0">
                                                {% if uk_call_date %}
                                                    <span class="id-call-date">{{ uk_call_date }}</span>
                                                {% else %}
                                                    <span class="id-call-date">{{ uk_due_date }}</span>
                                                {% endif %}
                                            </h2>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
                <div class="card-body">
                    {% if filter %}
                        <div class="pull-left">
                            <p>Number of results: {{ filtered_count }}</p>
                        </div>
                    {% endif %}
                    {% if not history %}
                        <div class="col-sm-12 text-right">
                            <button class="btn btn-secondary btn-sm" data-toggle="modal" data-target="#id-archive-batch-modal">
                                <i class="fa fa-archive"></i> Archive
                            </button>
                            <button class="btn btn-warning btn-sm" data-toggle="modal" data-backdrop="static" data-target="#id-update-call-date-modal">
                                <i class="fa fa-edit"></i> Update Actual Due Date
                            </button>
                            <button class="btn btn-success btn-sm submit-batch" data-url="{% url 'core_dd_drawdowns:process_drawdowns' batch_ref %}" id="id-submit-batch" {% if not count %}disabled{% endif %}>
                                <i class="fa fa-thumbs-up"></i> Submit Batch
                            </button>
                        </div>
                    {% endif %}
                    <table class="table table-striped table-bordered table-hover">
                        <thead>
                            <th>Agreement ID</th>
                            <th>Reference</th>
{#                            <th>Funder</th>#}
                            <th>Customer</th>
                            <th>Amount</th>
                            <th>Account Details</th>
                            <th>Type</th>
                            <th>Phase</th>
                            <th>DDI Status</th>
                            {% if not history %}
                                <th style="width:93px">
                                    <div class="switch d-inline">
                                        <input type="checkbox" id="hideAllDrawdowns" {% if count %}checked{% else %}unchecked{% endif %}>
                                        <label for="hideAllDrawdowns"></label>
                                    </div>
                                </th>

                                <div class="checkbox">
                                {#{#                                    <input id="checkbox1" type="checkbox" id="applyAllCheckbox">#}
                                {#{#                                    <label for="checkbox1" id="applyAll"></label>#}
                                {#{#                                    <label class="text-danger" id="removeAll" style="display:none;"><i class="fa fa-remove"></i></label>#}
                                {#{#                                </div>#}
                            {% endif %}
                        </thead>
                        <tbody>
                            {% for rec in records %}
                                <tr data-drawdown-id="{{ rec.id }}" {% if rec.status.text_code == 'REMOVED' %}style="opacity: 0.65"{% endif %}>
                                    <td>{{ rec.agreement_id }}</td>
                                    <td>
                                        {% if rec.reference %}
                                            {{ rec.reference }}
                                        {% else %}
                                            <span class="text-danger">No Reference</span>
                                        {% endif %}
                                    </td>
{#                                    <td>#}
{#                                    {% if rec.funder_id == '1' %}#}
{#                                        <span class="badge badge-default">Nationwide</span>#}
{#                                    {% elif rec.funder_id == '2' %}#}
{#                                        <span class="badge badge-success">BlueRock</span>#}
{#                                    {% else %}#}
{#                                        <span class="badge badge-danger">Issue</span>#}
{#                                    {% endif %}#}
{#                                    </td>#}
                                    <td>{{ rec.customer_name }}</td>
                                    <td>&pound;{{ rec.amount }}</td>
                                    <td>
                                        {% if rec.sort_code and rec.account_number %}
                                            {{ rec.sort_code }} / {{ rec.account_number }}
                                        {% else %}
                                            <span class="text-danger">No Bank Details</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ rec.agreement_type }}</td>
                                    <td>{{ rec.agreement_phase }}</td>
                                    <td>
                                        {% if rec.reference %}
                                            {% if rec.ddi_status.dd_text_description == 'Active DD' %}
                                                <i class="ti-check font-size-12 text-success"></i>
                                            {% else %}
                                                <i class="ti-close font-size-12 text-danger"></i>
                                            {% endif %}
                                        {% else %}
                                            <span class="badge badge-danger">NO SETUP</span>
                                        {% endif %}
                                    </td>
                                    {% if not history %}
                                    <td>
{#                                        {% if rec.agreement_origin_flag %}#}
                                        <a href="{% url 'core_agreement_crud:agreement_management_tab4' rec.agreement_id %}" class="text-success m-r-15"><i class="ti-pencil"></i></a>
{#                                        {% else %}#}
{#                                            &nbsp; &nbsp;  &nbsp; &nbsp;#}
{#                                        {% endif %}#}
{#                                      <a href="{% url 'dashboard:AgreementEnquiryDetail' rec.agreement_id %}" class="text-success m-r-15"><i class="ti-layers"></i></a>#}
                                        <div class="switch d-inline">
                                            <input type="checkbox" id="hideDrawdown{{ rec.id }}" data-remove-url="{% url 'core_dd_drawdowns:soft_delete_drawdown' rec.batch_header.reference rec.id %}" {% if not rec.status.text_code == 'REMOVED' %}checked{% endif %} data-readd-url="{% url 'core_dd_drawdowns:re_add_drawdown' rec.batch_header.reference rec.id %}">
                                            <label for="hideDrawdown{{ rec.id }}"></label>
                                        </div>
                                    </td>
                                    {% endif %}
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
{#                    {% if not history %}#}
{#                    <div class="pull-right">#}
{#                        <button class="btn btn-success btn-sm submit-batch" data-url="{% url 'core_dd_drawdowns:process_drawdowns' batch_ref %}" id="id-submit-batch" {% if not count %}disabled{% endif %}>#}
{#                            <i class="fa fa-thumbs-up"></i> Submit Batch#}
{#                        </button>#}
{#                    </div>#}
{#                    {% endif %}#}
                </div>
                <div class="card-footer border bottom text-center">
                    <div>
                        <div class="dataTables_paginate paging_simple_numbers">
                    <ul class="pagination">
                        {% if records.has_previous %}
                            <li class="paginate_button page-item previous">
                                {% if 'agreement_id__contains' in request.get_full_path %}
                                    <a onclick="window.performUnload=false;" href="{{ request.get_full_path }}&page={{ records.previous_page_number }}" aria-controls="dt-opt" data-dt-idx="0" tabindex="0" class="page-link">Previous</a>
                                {% else %}
                                    <a onclick="window.performUnload=false;" href="?page={{ records.previous_page_number }}" aria-controls="dt-opt" data-dt-idx="0" tabindex="0" class="page-link">Previous</a>
                                {% endif %}
                            </li>
                        {% else %}
                            <li class="paginate_button page-item previous disabled">
                                <a href="#" aria-controls="dt-opt" data-dt-idx="0" tabindex="0" class="page-link">Previous</a>
                            </li>
                        {% endif %}
                        {% for i in records.paginator.page_range %}
                            {% if records.number == i %}
                                <li class="paginate_button page-item active">
                                    {% if 'agreement_id__contains' in request.get_full_path %}
                                        <a onclick="window.performUnload=false;" href="{{ request.get_full_path }}&page={{ i }}" aria-controls="dt-opt" data-dt-idx="1" tabindex="0" class="page-link">{{ i }}</a>
                                    {% else %}
                                        <a onclick="window.performUnload=false;" href="?page={{ i }}" aria-controls="dt-opt" data-dt-idx="1" tabindex="0" class="page-link">{{ i }}</a>
                                    {% endif %}
                                </li>
                            {% else %}
                            {% if records.number < i %}
                                {% if records.number|add:"1" >= i %}
                                    <li class="paginate_button page-item">
                                        {% if 'agreement_id__contains' in request.get_full_path %}
                                            <a onclick="window.performUnload=false;" href="{{ request.get_full_path }}&page={{ i }}" aria-controls="dt-opt" data-dt-idx="1" tabindex="0" class="page-link">{{ i }}</a>
                                        {% else %}
                                            <a onclick="window.performUnload=false;" href="?page={{ i }}" aria-controls="dt-opt" data-dt-idx="1" tabindex="0" class="page-link">{{ i }}</a>
                                        {% endif %}
                                    </li>
                                {% else %}
                                {% if records.paginator.num_pages == i %}
                                    <li class="paginate_button page-item disabled">
                                        <a href="#" aria-controls="dt-opt" data-dt-idx="1" tabindex="0" class="page-link">
                                            <i class="mdi mdi-dots-horizontal"></i>
                                        </a>
                                    </li>
                                    <li class="paginate_button page-item">
                                        {% if 'agreement_id__contains' in request.get_full_path %}
                                            <a onclick="window.performUnload=false;" href="{{ request.get_full_path }}&page={{ i }}" aria-controls="dt-opt" data-dt-idx="1" tabindex="0" class="page-link">{{ i }}</a>
                                        {% else %}
                                            <a onclick="window.performUnload=false;" href="?page={{ i }}" aria-controls="dt-opt" data-dt-idx="1" tabindex="0" class="page-link">{{ i }}</a>
                                        {% endif %}
                                    </li>
                                {% endif %}
                                {% endif %}
                            {% endif %}
                                {% if records.number > i %}
                                    {% if records.number|add:"-2" < i  %}
                                        <li class="paginate_button page-item">
                                            {% if 'agreement_id__contains' in request.get_full_path %}
                                                <a onclick="window.performUnload=false;" href="{{ request.get_full_path }}&page={{ i }}" aria-controls="dt-opt" data-dt-idx="1" tabindex="0" class="page-link">{{ i }}</a>
                                            {% else %}
                                                <a onclick="window.performUnload=false;" href="?page={{ i }}" aria-controls="dt-opt" data-dt-idx="1" tabindex="0" class="page-link">{{ i }}</a>
                                            {% endif %}
                                        </li>
                                    {% else %}
                                    {% if 1 == i %}
                                        <li class="paginate_button page-item">
                                            {% if 'agreement_id__contains' in request.get_full_path %}
                                                <a onclick="window.performUnload=false;" href="{{ request.get_full_path }}&page={{ i }}" aria-controls="dt-opt" data-dt-idx="1" tabindex="0" class="page-link">{{ i }}</a>
                                            {% else %}
                                                <a onclick="window.performUnload=false;" href="?page={{ i }}" aria-controls="dt-opt" data-dt-idx="1" tabindex="0" class="page-link">{{ i }}</a>
                                            {% endif %}
                                        </li>
                                        <li class="paginate_button page-item disabled">
                                            <a href="#" aria-controls="dt-opt" data-dt-idx="1" tabindex="0" class="page-link">
                                                <i class="mdi mdi-dots-horizontal"></i>
                                            </a>
                                        </li>
                                    {% endif %}
                                    {% endif %}
                                {% endif %}
                            {% endif %}
                        {% endfor %}
                        {% if records.has_next %}
                            <li class="paginate_button page-item next" id="dt-opt_next">
                                {% if 'agreement_id__contains' in request.get_full_path %}
                                    <a onclick="window.performUnload=false;" href="{{ request.get_full_path }}&page={{ records.next_page_number }}" aria-controls="dt-opt" data-dt-idx="3" tabindex="0" class="page-link">Next</a>
                                {% else %}
                                    <a onclick="window.performUnload=false;" href="?page={{ records.next_page_number }}" aria-controls="dt-opt" data-dt-idx="1" tabindex="0" class="page-link">Next</a>
                                {% endif %}
                            </li>
                        {% else %}
                            <li class="paginate_button page-item next disabled" id="dt-opt_next">
                                <a href="#" aria-controls="dt-opt" data-dt-idx="3" tabindex="0" class="page-link">Next</a>
                            </li>
                        {% endif %}
                    </ul>
                </div>
                    </div>
                </div>
            </div>

            <!-- Add DrawDown Modal -->
            <div class="modal fade in">
                <div class="modal-dialog">

                </div>
            </div>
`
            <!-- Confirm Remove All Drawdowns Modal -->
            <div class="modal fade in" id="removeAllConfirmModal">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h2>Are you sure?</h2>
                        </div>
                        <div class="modal-body">
                            <div class="alert alert-danger">
                                <p><b>Please confirm you wish to remove all {{ filtered_count }} drawdowns from the batch.</b></p>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-success" id="confirm-remove-all" data-filter='{{ json_filter }}' data-url="{% url 'core_dd_drawdowns:delete_drawdowns' batch_ref %}">
                                Confirm
                            </button>
                            <button class="btn btn-danger" id="cancelRemoveAll" data-dismiss="modal">
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Confirm Remove DrawDown Modal -->
            <div class="modal fade in" id="confirm-remove-drawdown">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h2>Are you sure?</h2>
                        </div>
                        <div class="modal-body">
                            <div class="alert alert-danger">
                                <p><b>Please confirm you wish to remove the selected drawdown from this batch.</b></p>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-success confirm-remove-single">
                                Confirm
                            </button>
                            <button class="btn btn-danger" data-dismiss="modal" id="cancel-remove-single" data-dismiss="modal">
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>
            </div>

             <!-- Confirm Add All Drawdowns Modal -->
            <div class="modal fade in" id="addAllDrawdownsModal">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h2>Are you sure?</h2>
                        </div>
                        <div class="modal-body">
                            <div class="alert alert-info">
                                <p><b>Please confirm you wish to re-add all {{ filtered_count }} drawdowns into this batch.</b></p>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-success" id="confirm-add-all" data-filter='{{ json_filter }}' data-url="{% url 'core_dd_drawdowns:delete_drawdowns' batch_ref %}">
                                Confirm
                            </button>
                            <button class="btn btn-danger" id="cancelAddAll" data-dismiss="modal">
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Confirm ADD DrawDown Modal -->
            <div class="modal fade in" id="confirm-add-drawdown">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h2>Are you sure?</h2>
                        </div>
                        <div class="modal-body">
                            <div class="alert alert-info">
                                <p><b>Please confirm you wish to re-add the selected drawdown into this batch.</b></p>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-success confirm-add-single">
                                Confirm
                            </button>
                            <button class="btn btn-danger" data-dismiss="modal">
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Confirm Submit Batch Modal -->
            <div class="modal fade in" id="confirm-submit-batch">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h2>Are you sure?</h2>
                        </div>
                        <div class="modal-body">
                            <div class="alert alert-danger submit-drawdown-error" style="display:none;"></div>
                            <div class="ct-chart" id="pie-custom-label" hidden></div>
                            <div class="alert alert-info">
                                <b>Please confirm you wish to submit this batch for <span class="id-call-date">{{ uk_call_date }}</span>:</b>
                            </div>
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th></th>
                                        <th>Count</th>
                                        <th>Amount</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>Profile Balance</td>
                                        <td id="forecast_grand_total_count">{{ forecast.grand_total.count }}</td>
                                        <td id="forecast_grand_total_amount">&pound;{{ forecast.grand_total.amount }}</td>
                                    </tr>
                                    <tr>
                                        <td>Removed</td>
                                        <td><span id="forecast_removed_count_minus">{% if forecast.removed.count %}-{% endif %}</span><span id="forecast_removed_count">{{ forecast.removed.count }}</span></td>
                                        <td><span id="forecast_removed_amount_minus">{% if forecast.removed.count %}-{% endif %}</span>&pound;<span id="forecast_removed_amount">{{ forecast.removed.amount }}</span></td>
                                    </tr>
                                    <tr>
                                        <th>Total to be submitted</th>
                                        <th><span id="forecast_count">{{ count }}</span></th>
                                        <th>&pound;<span id="forecast_amount">{{ amount }}</span></th>
                                    </tr>
                                    <tr>
                                        <td colspan="3"><p>&nbsp;</p></td>
                                    </tr>
                                    <tr>
                                        <td>Forecast Bounces &nbsp; <i class="fa fa-chevron-circle-right cursor-pointer toggle_forecast_bounce"></i><i class="fa fa-chevron-circle-down cursor-pointer toggle_forecast_bounce" style="display: none;"></i></td>
                                        <td><span id="forecast_bounces_count">{{ forecast.bounces.count }}</span></td>
                                        <td>&pound; <span id="forecast_bounces_amount">{{ forecast.bounces.amount }}</span></td>
                                    </tr>
                                    <tr class="forecast_bounce_info">
                                        <td>&nbsp; &nbsp; <i>- Inactive DD</i></td>
                                        <td><i><span id="forecast_inactive_count">{{ forecast.inactive.count }}</span></i></td>
                                        <td><i>&pound;<span id="forecast_inactive_amount">{{ forecast.inactive.amount }}</span></i></td>
                                    </tr>
                                    <tr class="forecast_bounce_info">
                                        <td>&nbsp; &nbsp; <i>- No Setup</i></td>
                                        <td><i><span id="forecast_no_setup_count">{{ forecast.no_setup.count }}</span></i></td>
                                        <td><i>&pound;<span id="forecast_no_setup_amount">{{ forecast.no_setup.amount }}</span></i></td>
                                    </tr>
                                    <tr>
                                        <td>Forecast Receipts</td>
                                        <td><span id="forecast_active_count">{{ forecast.active.count }}</span></td>
                                        <td>&pound;<span id="forecast_active_amount">{{ forecast.active.amount }}</span></td>
                                    </tr>
                                </tbody>
                            </table>
                            <div class="alert alert-info" hidden>
                                <p><b>Please confirm you wish to submit this batch of:</b></p>
                                <p>
                                    <ul>
                                        <li>Count: {{ count }}</li>
                                        <li>Amount: &pound;{{ amount }}</li>
                                        <li>Due on: {{ due_date }}</li>
                                    </ul>
                                </p>
                                <p>
                                    <ul class="text-danger">
                                        <li>Forecast Bounce Count: {{ b_count }}</li>
                                        <li>Forecast Bounce Amount: &pound;{{ b_amount }}</li>
                                    </ul>
                                </p>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <div class="col-sm-12 submit-drawdown-loading">
                                <div class="alert alert-danger text-center">
                                    <i class="fa fa-pulse fa-spinner fa-2x"></i>
                                    <h2>Sending in progress...</h2>
                                    <b>Please do not navigate away from this screen.</b>
{#                                    <div id="progressBar" style="color: black;">#}
{#                                        <div class="bar"></div>#}
{#                                    </div>#}
                                    <div id="myProgress">
                                      <div id="myBar">10%</div>
                                    </div>
                                </div>
                            </div>
                            <div class="submit-drawdown-buttons">
                                <i class="fa fa-pulse fa-spinner fa-2x submit-drawdown-loading"></i>
                                <button class="btn btn-success confirm-submit">
                                    Confirm
                                </button>
                                <button class="btn btn-danger" data-dismiss="modal">
                                    Cancel
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- CSRF Token -->
            <input type="hidden" value="{{ csrf_token }}" id="csrf-token">

        {% endif %}

    {% endif %}

    <div class="modal fade modal-fs" id="modal-fs" aria-hidden="true" style="display: none;">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-body">
                    <div class="container text-center">
                        <div class="row full-height align-items-center">
                            <div class="col-md-5 m-h-auto">
                                <div class="p-h-30 p-b-50">
                                    <div class="text-center font-size-70">
                                        <i class="fa fa-remove icon-gradient-danger"></i>
                                    </div>
                                    <h1 class="text-thin m-v-15">Duplicate Session</h1>
                                    <p class="m-b-25 lead">You already have this screen open in another tab/window.</p>
                                    <div class="text-center">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>



    <div class="modal fade" id="id-update-call-date-modal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title">Update Actual Due Date</h3>
{#                    <button class="close" data-dismiss="modal">&times;</button>#}
                </div>
                <div class="modal-body">
                    <div class="alert alert-danger" id="id-call-date-error" style="display: none;"></div>
                    <div class="form-group">
                        <label class="control-label">Actual Due Date:</label>
                        <input type="date" class="form-control" id="id-call-date-value">
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-success" id="id-update-call-date">
                        Update
                    </button>
                    <button class="btn btn-danger" data-dismiss="modal">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

        {% if batch_ref %}

    <div class="modal fade" id="id-archive-batch-modal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title">Are You Sure?</h3>
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-danger">
                        <b>Archiving this batch is irreversible. Please confirm you wish to continue.</b>
                    </div>
                </div>
                <div class="modal-footer">
                    <form method="POST" action="{% url 'core_dd_drawdowns:archive_batch' batch_ref %}">
                        {% csrf_token %}
                        <button class="btn btn-success" type="submit" id="id-archive-batch">
                            Confirm
                        </button>
                    </form>
                    <button class="btn btn-danger" data-dismiss="modal">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

            {% endif %}

    <div class="modal fade" id="id-expired-modal">
        <div class="modal-dialog">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title">Actual Due Date Out Of Bounds</h3>
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-danger">
                        <p><b>Important:</b> The current Actual Due Date of <span id="span-call-date"></span> is not achievable.</p>
                        <p>The earliest possible Actual Due Date is <span id="span-earlier-call-date"></span>.</p>
                        <b>You must update the Actual Due Date before you will be able to submit this batch.</b>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-danger" data-dismiss="modal">
                        &larr; Back
                    </button>
                </div>
            </div>
        </div>
    </div>

        {% endif %}

{% endblock %}
{% block page-js %}

    <script src="{% static 'core_dd_drawdowns.js' %}"></script>
    <script src="{% static 'assets/vendor/chartist-js/dist/chartist.min.js' %}"></script>
    <!--<script src="{% static 'assets/js/charts/chartist.js' %}"></script>-->
    <script src="{% static 'duplicate.js' %}"></script>


    <script type="text/javascript">

        sessionStorage.removeItem('onUnload');

        {% if history %}
            $("#batch_info").show();
        {% endif %}

        {% if batch_lock %}
            {% if batch_lock_check %}
                if(sessionStorage.getItem("GoBatchLock") === "{{ batch_lock.session_id }}") {
                    if(window.IsDuplicate()) {
                        $("#modal-fs").modal({"backdrop": "static", "keyboard": false})
                    } else {
                        $("#batch_info").show();
                        _unloadBatchLock();
                    }
                } else {
                    $("#batch_error").html("Batch is locked by {{ batch_lock.user }} on {{ batch_lock.created }}").show();
                }
            {% else %}
                if(window.IsDuplicate()) {
                    $("#modal-fs").modal({"backdrop": "static", "keyboard": false});
                } else {
                    sessionStorage.setItem("GoBatchLock", "{{ batch_lock.session_id }}");
                    $("#batch_info").show();
                    _unloadBatchLock();
                }
            {% endif %}
        {% else %}
            $("#batch_info").show();
        {% endif %}

        window.performUnload = true ;

        {% if batch_ref %}
        function _unloadBatchLock() {
            document.body.onbeforeunload = function () {
                console.log('performUnload', window.performUnload, '{{ batch_lock.session_id }}');
                if (!window.performUnload) {
                    window.performUnload = true;
                    return;
                }
                sessionStorage.removeItem("GoBatchLock");
                $.ajax({
                    method: 'POST',
                    url: '{% url 'core_dd_drawdowns:unlock_batch' batch_ref %}',
                    data: {
                        session_id: '{{ batch_lock.session_id }}'
                    },
                    beforeSend: function (xhr) {
                        xhr.setRequestHeader('X-CSRFToken', '{{ csrf_token }}')
                    }
                });
            };
        }
        {% endif %}

    </script>

    <script type="text/javascript">

        var showModal = true ;
        var removeURL = '';
        var readdURL = '';

        $(function() {

            var forecastBounceInfo = $(".forecast_bounce_info");
            var toggleForecastBounces = $(".toggle_forecast_bounce");

            toggleForecastBounces.click(function() {
                toggleForecastBounces.toggle();
                forecastBounceInfo.toggle();
            });

            {% if batch_ref %}

            var $updateError = $("#id-call-date-error");
            var $updateButtons = $("#id-call-date-buttons button") ;
            var updateClick = false ;

            $("#id-update-call-date").click(function() {

                if (updateClick) return ;

                updateClick = true ;

                $updateError.html("").hide();

                var call_date = $("#id-call-date-value").val() ;

                if (! call_date) {
                    $updateError.html("Please select an Actual Due Date.").show() ;
                    updateClick = false ;
                    return ;
                }

                var jMaxDate = "";
                var jcallDate = "" ;

                try {
                    jMaxDate = new Date() ;
                    jcallDate = new Date(call_date) ;
                } catch(err) {
                    $updateError.html("Invalid Actual Due Date.").show() ;
                    updateClick = false ;
                    return ;
                }

                jMaxDate.setDate(jMaxDate.getDate() + 6) ;

                if (jcallDate.getTime() < jMaxDate.getTime()) {
                    $updateError.html("Actual Due Date must be greater than 7 days away.").show() ;
                    updateClick = false ;
                    return ;
                }

                $updateButtons.attr("disabled", "disabled") ;

                $.ajax({
                    url: "{% url 'core_dd_drawdowns:update_call_date' batch_ref %}",
                    method: 'POST',
                    data: {
                        call_date: call_date
                    },
                    beforeSend: function(xhr) {
                        xhr.setRequestHeader("X-CSRFToken", "{{ csrf_token }}")
                    },
                    success: function(data) {
                        updateClick = false ;
                        if(data.success) {
                            $(".id-call-date").html(data.success);
                            $updateButtons.removeAttr("disabled");
                            $("#id-update-call-date-modal").modal("hide");

                            return ;
                        }
                        $updateError.html("Actual Due Date is invalid.").show();

                    },
                    error: function(data) {
                        alert(JSON.stringify(data)) ;
                        $updateError.html("Internal server error.").hide() ;
                        $updateButtons.removeAttr("disabled") ;
                        updateClick = false ;
                    }
                });

            });

            $("#hideAllDrawdowns").click(function(e) {

                if(showModal) {

                    e.preventDefault();

                    if($(this).is(":checked")) {
                        $("#addAllDrawdownsModal").modal({"backdrop": "static"});
                    } else {
                        $("#removeAllConfirmModal").modal({"backdrop": "static"});
                    }

                }

            });

            $("#confirm-remove-all").click(function() {

                showModal = false ;

                $("[id^=hideDrawdown]").each(function() {

                    if($(this).is(":checked")) {
                        $(this).trigger("click");
                    }
                    $(this).parents(':eq(2)').css("opacity", "0.65");
                    $("#removeAllConfirmModal").modal("hide");

                });

                $("#hideAllDrawdowns").trigger("click");

                $.ajax({
                    method: 'POST',
                    url: "{% url 'core_dd_drawdowns:soft_delete_drawdowns' batch_ref %}" + location.search,
                    beforeSend: function(xhr) {
                        xhr.setRequestHeader("X-CSRFToken", "{{ csrf_token }}") ;
                    },
                    success: function(data) {
                        if (data.forecast) {
                            _update_forecast(data.forecast) ;
                        }
                    },
                    error: function(data) {
                        alert(JSON.stringify(data));
                        $("#hideAllDrawdowns").trigger("click");
                    }
                });

                showModal = true ;

            });

            $("#confirm-add-all").click(function() {

                showModal = false ;

                $("[id^=hideDrawdown]").each(function() {

                    if(!$(this).is(":checked")) {
                        $(this).trigger("click");
                    }
                    $(this).parents(':eq(2)').css("opacity", "1");

                    $("#addAllDrawdownsModal").modal("hide");

                });

                $("#hideAllDrawdowns").trigger("click");

                $.ajax({
                    method: 'POST',
                    url: "{% url 'core_dd_drawdowns:re_add_drawdowns' batch_ref %}" + location.search,
                    beforeSend: function(xhr) {
                        xhr.setRequestHeader("X-CSRFToken", "{{ csrf_token }}") ;
                    },
                    success: function(data) {
                        if (data.forecast) {
                            _update_forecast(data.forecast) ;
                        }
                    },
                    error: function(data) {
                        alert(JSON.stringify(data));
                        $("#hideAllDrawdowns").trigger("click");
                    }
                });

                showModal = true ;

            });

            var confirmAddSingle = $(".confirm-add-single");
            var confirmRemoveSingle = $(".confirm-remove-single");

            $("#id-test").click(function() {
                alert("clicked!");
            });

            $("[id^=hideDrawdown]").click(function(e) {

                if(showModal) {

                    var t = this ;
                    readdURL = t.getAttribute('data-readd-url');
                    removeURL = t.getAttribute('data-remove-url');

                    e.preventDefault();

                    if($(t).is(":checked")) {

                        $("#confirm-add-drawdown").modal();

                        confirmAddSingle.off("click");

                        confirmAddSingle.click(function() {

                            var tt = this;
                            this.disabled = true ;

                            $.ajax({
                                method: 'POST',
                                url: readdURL,
                                beforeSend: function(xhr) {
                                    xhr.setRequestHeader("X-CSRFToken", "{{ csrf_token }}");
                                },
                                success: function(data) {

                                    _update_forecast(data.forecast);

                                    showModal = false ;

                                    console.log('switch on a')
                                    $(t).trigger("click");


                                    $(t).parents(':eq(2)').css("opacity", "1");

                                    $("#confirm-add-drawdown").modal("hide");

                                    tt.disabled = false ;
                                    $("#cancel-add-single").show();

                                    showModal = true;
                                },
                                error: function(res) {
                                    alert(JSON.stringify(res));
                                }
                            });

                            $(t).trigger("click");

                            $(t).parents(':eq(2)').css("opacity", "1");

                            $("#confirm-add-drawdown").modal("hide");

                            showModal = true ;

                        });

                    } else {

                        $("#confirm-remove-drawdown").modal();

                        confirmRemoveSingle.off("click");

                        confirmRemoveSingle.click(function () {

                            var tt = this ;
                            tt.disabled = true ;

                            $("#cancel-remove-single").hide();

                            $.ajax({
                                method: 'POST',
                                url: removeURL,
                                beforeSend: function(xhr) {
                                    xhr.setRequestHeader("X-CSRFToken", "{{ csrf_token }}");
                                },
                                success: function(data) {

                                    _update_forecast(data.forecast);

                                    showModal = false ;

                                    $(t).trigger("click");

                                    $(t).parents(':eq(2)').css("opacity", "0.65");

                                    $("#confirm-remove-drawdown").modal("hide");

                                    tt.disabled = false ;
                                    $("#cancel-remove-single").show();

                                   showModal = true;
                                },
                                error: function(res) {
                                    alert(JSON.stringify(res));
                                }
                            });

                        });

                    }

                } else {
                        console.log('switch on b');
                }

            });

            $(".confirm-submit").click(function() {
                // progress(0, 99, $('#progressBar'));
                move();
            });

        });


        {% endif %}

        var count = "{{ count }}";

        function _update_forecast(data) {

            count = data.open.count ;

            if (data.open.count > 0) {
                $("#id-submit-batch").attr("disabled", false) ;
            } else {
                $("#id-submit-batch").attr("disabled", true) ;
            }

            $("#forecast_count").html(data.open.count);
            $("#forecast_amount").html(data.open.amount);

            $("#forecast_removed_count").html(data.removed.count);
            $("#forecast_removed_amount").html(data.removed.amount);

            if(data.removed.count) {
                $("#forecast_removed_count_minus").html("-");
                $("#forecast_removed_amount_minus").html("-");

            }  else {
                $("#forecast_removed_count_minus").html("");
                $("#forecast_removed_amount_minus").html("");

            }

            $("#forecast_bounces_count").html(data.bounces.count);
            $("#forecast_bounces_amount").html(data.bounces.amount);

            $("#forecast_inactive_count").html(data.inactive.count);
            $("#forecast_inactive_amount").html(data.inactive.amount);

            $("#forecast_no_setup_count").html(data.no_setup.count);
            $("#forecast_no_setup_amount").html(data.no_setup.amount);

            $("#forecast_active_count").html(data.active.count);
            $("#forecast_active_amount").html(data.active.amount);

            $("#forecast_grand_total_count").html(data.grand_total.count);
            $("#forecast_grand_total_amount").html(data.grand_total.amount);

            $("#id-total-count").html(data.open.count) ;
            $("#id-total-amount").html(data.open.amount) ;

        }

        function progress(timeleft, timetotal, $element) {
            var progressBarWidth = timeleft * $element.width() / timetotal;
            $element.find('div').animate({ width: progressBarWidth }, 0).html(Math.floor(timeleft) + "%");
            if(timeleft < 100) {
                setTimeout(function() {
                    var t = timeleft + (100 / count) ;
                    console.log(t) ;
                    progress(t, timetotal, $element);
                }, 250);
            }
        };

        function move() {

            var elem = document.getElementById("myBar");

            elem.style.width = '0%';

            var width = 10;

            var id = setInterval(frame, (count * 2.3) + 40);

            function frame() {

                if (width >= 100) {
                    clearInterval(id);
                } else {
                    width++;
                    elem.style.width = width + '%';
                    elem.innerHTML = width * 1 + '%';
                }
            }
        }

    </script>

{% endblock %}
